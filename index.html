<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>Danh s√°ch An t√°ng / C·∫£i t√°ng ¬∑ Hoa Vi√™n Nghƒ©a Trang B√¨nh D∆∞∆°ng</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet" />

    <style>
        .page-header-inner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            flex-wrap: wrap;
        }

        .brand-logo {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: 1px solid rgba(248, 220, 140, 0.85);
            background: radial-gradient(circle at 30% 20%, #f4b528 0, #7a5a1c 40%, #000 100%);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.65);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-logo img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .brand-text {
            text-align: left;
        }

        @media (max-width: 600px) {
            .brand-text {
                text-align: center;
            }
        }

        :root {
            --bg: #050508;
            --card-bg: #111319;
            --card-border: #272a36;
            --accent: #f4b528;
            --accent-soft: #f8d070;
            --text: #f7f7fb;
            --muted: #a6acc7;
            --danger: #ff6b6b;
            --radius-lg: 16px;
            --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at top, #1c1f2c 0, #050508 55%);
            color: var(--text);
            font-family: "Roboto", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .page {
            max-width: 1120px;
            margin: 0 auto;
            padding: 24px 16px 80px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-family: "Montserrat", system-ui;
            font-weight: 700;
            letter-spacing: 0.12em;
            font-size: 14px;
            text-transform: uppercase;
            color: var(--accent-soft);
        }

        .page-subtitle {
            margin-top: 8px;
            font-size: 26px;
            font-weight: 700;
        }

        .page-desc {
            margin-top: 6px;
            color: var(--muted);
            font-size: 14px;
        }

        .filters-row {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .chip {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(244, 181, 40, 0.3);
            color: var(--accent-soft);
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.4);
        }

        .list-container {
            margin-top: 28px;
            background: rgba(4, 6, 12, 0.8);
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 12px 12px 4px;
            backdrop-filter: blur(16px);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px 10px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        .list-header div {
            flex: 1;
        }

        .list-header div:nth-child(2) {
            flex: 2;
        }

        .events-list {
            max-height: calc(100vh - 230px);
            overflow-y: auto;
            padding: 4px;
        }

        .event-card {
            display: grid;
            grid-template-columns: 100px minmax(0, 1.6fr) minmax(0, 1.2fr);
            gap: 10px;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 12px;
            background: radial-gradient(circle at left, rgba(244, 181, 40, 0.18), rgba(6, 9, 20, 0.9));
            border: 1px solid rgba(148, 163, 184, 0.4);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease;
        }

        .event-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border-color: rgba(244, 181, 40, 0.7);
        }

        /* M√†u kh√°c nhau cho An t√°ng / C·∫£i t√°ng */
        .event-card--antang {
            background: radial-gradient(circle at left, rgba(244, 181, 40, 0.20), rgba(6, 9, 20, 0.95));
            border-color: rgba(248, 220, 140, 0.6);
        }

        .event-card--caitang {
            background: radial-gradient(circle at left, rgba(45, 212, 191, 0.20), rgba(6, 12, 20, 0.96));
            border-color: rgba(56, 189, 248, 0.65);
        }

        .event-time {
            font-size: 13px;
            color: var(--accent-soft);
            font-weight: 600;
            white-space: nowrap;
        }

        .event-name {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 2px;
        }

        .event-birth {
            font-size: 13px;
            font-weight: 500;
            color: #f8d070;
            letter-spacing: 0.01em;
            line-height: 1.6;
            margin-top: 4px;
        }

        .event-meta {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            line-height: 1.5;
        }

        .event-location {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.6;
        }

        .event-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 9px;
            border-radius: 999px;
            font-size: 11px;
            margin-bottom: 4px;
            background: rgba(0, 0, 0, 0.35);
            gap: 6px;
        }

        .event-badge-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            display: inline-block;
        }

        .event-badge--antang {
            border: 1px solid rgba(248, 220, 140, 0.9);
            color: #fef9c3;
        }

        .event-badge--antang .event-badge-dot {
            background: #facc15;
        }

        .event-badge--caitang {
            border: 1px solid rgba(56, 189, 248, 0.9);
            color: #a5f3fc;
            background: rgba(8, 47, 73, 0.85);
        }

        .event-badge--caitang .event-badge-dot {
            background: #22c55e;
        }

        /* H√†ng action: M·ªü c√°o ph√≥ ri√™ng / Xem m√£ QR */
        .event-actions {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            font-size: 12px;
        }

        .action-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(248, 220, 140, 0.6);
            background: rgba(10, 10, 10, 0.65);
            color: var(--accent-soft);
            text-decoration: none;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
        }

        .action-pill--primary {
            background: radial-gradient(circle at top, rgba(248, 220, 140, 0.18), rgba(12, 10, 5, 0.9));
            color: #fefce8;
            font-weight: 500;
        }

        .action-pill--ghost {
            border-color: rgba(148, 163, 184, 0.7);
            color: var(--muted);
            background: rgba(15, 23, 42, 0.75);
        }

        .action-pill-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            font-size: 11px;
        }

        .action-pill:hover {
            transform: translateY(-0.5px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.6);
            border-color: rgba(248, 220, 140, 0.9);
        }

        .action-pill--ghost:hover {
            background: rgba(30, 41, 59, 0.9);
        }

        /* Modal QR */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 12px;
        }

        .modal-backdrop.visible {
            display: flex;
        }

        .modal {
            width: 100%;
            max-width: 520px;
            border-radius: 18px;
            background: #050506;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(248, 220, 140, 0.5);
            position: relative;
        }

        .obit-header {
            padding: 18px 16px 8px;
            text-align: center;
            background: radial-gradient(circle at top, #252525 0, #050506 55%);
        }

        .obit-title-top {
            font-family: "Montserrat", system-ui;
            font-size: 15px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent-soft);
            font-weight: 700;
        }

        .obit-subtitle {
            margin-top: 4px;
            font-size: 16px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
        }

        .obit-photo-placeholder {
            width: 210px;
            height: 210px;
            border-radius: 999px;
            margin: 12px auto 8px;
            background: radial-gradient(circle at 30% 20%, #444 0, #111 55%, #000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .08em;
            border: 3px solid rgba(248, 220, 140, 0.9);
            overflow: hidden;
        }

        .obit-photo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .obit-name-block {
            padding: 4px 16px 12px;
            text-align: center;
        }

        .obit-role {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-bottom: 4px;
        }

        .obit-name {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-soft);
        }

        .obit-name-alt {
            font-size: 14px;
            margin-top: 2px;
        }

        .obit-body {
            padding: 8px 20px 16px;
            font-size: 13px;
            line-height: 1.6;
            color: #f3f4ff;
        }

        .obit-section-title {
            margin-top: 12px;
            margin-bottom: 4px;
            font-weight: 700;
            color: var(--accent-soft);
            text-transform: uppercase;
            font-size: 13px;
            display: block;
        }

        .obit-footer {
            padding: 10px 16px 14px;
            text-align: center;
            font-size: 13px;
            border-top: 1px solid rgba(248, 220, 140, 0.4);
            color: var(--accent-soft);
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 26px;
            height: 26px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(5, 5, 6, 0.9);
            color: #e5e7eb;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        @media (max-width: 680px) {
            .events-list {
                max-height: calc(100vh - 260px);
            }

            .event-card {
                grid-template-columns: minmax(0, 1.3fr) minmax(0, 2fr);
                grid-auto-rows: auto;
                grid-template-areas:
                    "time name"
                    "time loc";
            }

            .event-time {
                grid-area: time;
            }

            .event-name {
                grid-area: name;
            }

            .event-location {
                grid-area: loc;
            }

            .list-header {
                display: none;
            }
        }

        /* --- LOADING SPINNER CSS --- */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(248, 220, 140, 0.2);
            border-top-color: var(--accent);
            /* M√†u v√†ng */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
        }

        .loading-sub {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <!-- Modal QR cho link c√°o ph√≥ -->
    <div id="qr-backdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" style="max-width:360px;">
            <button class="modal-close" id="qr-close" aria-label="ƒê√≥ng">√ó</button>
            <div style="padding:16px;text-align:center">
                <div style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--accent-soft)">
                    M√£ QR c√°o ph√≥
                </div>
                <img id="qr-image" src="" alt="QR c√°o ph√≥"
                    style="width:260px;height:260px;border-radius:16px;background:#000;" />
                <div id="qr-url" style="font-size:11px;margin-top:8px;color:var(--muted);word-break:break-all;"></div>
                <div style="font-size:11px;margin-top:4px;color:var(--muted);">
                    Qu√©t QR n√†y ƒë·ªÉ m·ªü trang c√°o ph√≥. C√≥ th·ªÉ nh·∫•n gi·ªØ ƒë·ªÉ l∆∞u ·∫£nh, d√πng cho in ·∫•n.
                </div>
            </div>
        </div>
    </div>

    <div class="page">
        <header class="page-header">
            <div class="page-header-inner">
                <div class="brand-logo">
                    <img src="CPH LOGO 1.png" alt="CPHACO logo">
                </div>
                <div class="brand-text">
                    <div class="page-title">HOA VI√äN NGHƒ®A TRANG B√åNH D∆Ø∆†NG</div>
                    <div class="page-subtitle">Danh s√°ch L·ªÖ An t√°ng ¬∑ C·∫£i t√°ng</div>
                </div>
            </div>
            <div class="page-desc">

            </div>
            <div class="filters-row">
                <span class="chip">S·∫Øp x·∫øp theo <strong>ng√†y gi·ªù ƒë·ªông quan</strong></span>
                <input id="search-input" type="text" placeholder="T√¨m theo t√™n, v·ªã tr√≠ ho·∫∑c n∆°i xu·∫•t ph√°t" 
                       style="flex:1;min-width:260px;max-width:520px;padding:8px 12px;border-radius:999px;border:1px solid rgba(244,181,40,0.3);background:rgba(0,0,0,0.4);color:#f7f7fb;" />
            </div>
        </header>

        <section class="list-container">
            <div class="list-header">
                <div>Th·ªùi gian</div>
                <div>H·ªç t√™n</div>
                <div>V·ªã tr√≠ / N∆°i xu·∫•t ph√°t</div>
            </div>
            <div id="events-list" class="events-list">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu ƒë√°m tang...</div>
                    <div class="loading-sub">Vui l√≤ng ƒë·ª£i gi√¢y l√°t n·∫øu Server ƒëang kh·ªüi ƒë·ªông l·∫°i</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal c√°o ph√≥ -->
    <div id="obit-backdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true">
            <button class="modal-close" id="obit-close" aria-label="ƒê√≥ng">√ó</button>

            <div class="obit-header">
                <div class="obit-title-top">HOA VI√äN NGHƒ®A TRANG B√åNH D∆Ø∆†NG</div>
                <div class="obit-subtitle">V√î C√ôNG TH∆Ø∆†NG TI·∫æC</div>
                <div class="obit-photo-placeholder" id="obit-photo-slot">
                    <span>·∫¢nh ch√¢n dung</span>
                </div>
            </div>

            <div class="obit-name-block">
                <div class="obit-role" id="obit-role">C√ÅO PH√ì</div>
                <div class="obit-name" id="obit-name">H·ªç t√™n ng∆∞·ªùi m·∫•t</div>
                <div class="obit-name-alt" id="obit-name-alt"></div>
            </div>

            <div class="obit-body" id="obit-body"></div>

            <div class="obit-footer" id="obit-footer">
                LINH C·ªÆU AN T√ÅNG T·∫†I HOA VI√äN NGHƒ®A TRANG B√åNH D∆Ø∆†NG
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://cphaco-backend-api.onrender.com";
        // const API_BASE_URL = "https://madly-tegminal-sheila.ngrok-free.dev";

        const eventsListEl = document.getElementById("events-list");
        const searchInputEl = document.getElementById("search-input");
        const obitBackdrop = document.getElementById("obit-backdrop");
        const obitCloseBtn = document.getElementById("obit-close");
        const obitNameEl = document.getElementById("obit-name");
        const obitNameAltEl = document.getElementById("obit-name-alt");
        const obitBodyEl = document.getElementById("obit-body");
        const obitFooterEl = document.getElementById("obit-footer");
        const obitRoleEl = document.getElementById("obit-role");

        const qrBackdrop = document.getElementById("qr-backdrop");
        const qrCloseBtn = document.getElementById("qr-close");
        const qrImg = document.getElementById("qr-image");
        const qrUrlText = document.getElementById("qr-url");

        function openQrModal(url) {
            const qrApi =
                "https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=" +
                encodeURIComponent(url);
            qrImg.src = qrApi;
            qrUrlText.textContent = url;
            qrBackdrop.classList.add("visible");
        }

        function closeQrModal() {
            qrBackdrop.classList.remove("visible");
        }

        qrCloseBtn.addEventListener("click", closeQrModal);
        qrBackdrop.addEventListener("click", (e) => {
            if (e.target === qrBackdrop) closeQrModal();
        });

        function formatDateTime(dtStr) {
            if (!dtStr) return "";
            const d = new Date(dtStr);
            if (Number.isNaN(d.getTime())) return dtStr;
            const dd = String(d.getDate()).padStart(2, "0");
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const yyyy = d.getFullYear();
            const hh = String(d.getHours()).padStart(2, "0");
            const mi = String(d.getMinutes()).padStart(2, "0");
            return `${hh} gi·ªù ${mi} ¬∑ ${dd}/${mm}/${yyyy}`;
        }

        function formatShortDateTime(dtStr) {
            if (!dtStr) return "";
            const d = new Date(dtStr);
            if (Number.isNaN(d.getTime())) return dtStr;
            const dd = String(d.getDate()).padStart(2, "0");
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const hh = String(d.getHours()).padStart(2, "0");
            const mi = String(d.getMinutes()).padStart(2, "0");
            return `${dd}/${mm} ¬∑ ${hh}:${mi}`;
        }

        // fallback n·∫øu sau n√†y c·∫ßn t√≠nh l·∫°i
        function calcAge(birthYear, refDateStr) {
            if (!birthYear) return null;
            const y = Number(birthYear);
            if (!y) return null;
            const ref = refDateStr ? new Date(refDateStr) : new Date();
            const age = ref.getFullYear() - y;
            return age > 0 ? age : null;
        }

        // L·∫•y th√¥ng tin lo·∫°i l·ªÖ t·ª´ ev.ceremony_type
        function getCeremonyInfo(ev) {
            const raw = (ev.ceremony_type || ev.type || "").toString().trim();
            if (!raw) {
                return { key: "antang", label: "An t√°ng" };
            }
            const norm = raw
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .trim();

            if (norm.includes("cai tang")) {
                return { key: "caitang", label: "C·∫£i t√°ng" };
            }
            if (norm.includes("an tang")) {
                return { key: "antang", label: "An t√°ng" };
            }
            // fallback: d√πng raw l√†m label, nh∆∞ng key m·∫∑c ƒë·ªãnh an t√°ng
            return { key: "antang", label: raw };
        }

        let allItems = [];

        function renderEventList(items) {
            eventsListEl.innerHTML = "";
            if (!items || !items.length) {
                eventsListEl.innerHTML =
                    '<div style="padding:10px;font-size:13px;color:#9ca3af;">Hi·ªán ch∆∞a c√≥ ca an t√°ng/c·∫£i t√°ng n√†o ƒëang tri·ªÉn khai.</div>';
                return;
            }

            // s·∫Øp x·∫øp theo time_of_funeral
            items.sort((a, b) => {
                const ta = a.time_of_funeral ? new Date(a.time_of_funeral).getTime() : 0;
                const tb = b.time_of_funeral ? new Date(b.time_of_funeral).getTime() : 0;
                return ta - tb;
            });

            for (const ev of items) {
                const typeInfo = getCeremonyInfo(ev);

                const card = document.createElement("div");
                card.className = "event-card event-card--" + typeInfo.key;
                card.dataset.jobId = ev.job_id;

                const timeText = ev.time_of_funeral
                    ? formatShortDateTime(ev.time_of_funeral)
                    : (ev.time_of_death ? formatShortDateTime(ev.time_of_death) : "");

                // H∆∞·ªüng d∆∞∆°ng / H∆∞·ªüng th·ªç: ∆∞u ti√™n ev.age_phrase
                const ageText = ev.age_phrase ? " ¬∑ " + ev.age_phrase : "";

                const posText = buildPositionFromEvent(ev);
                console.log(posText);
                
                // Link c√°o ph√≥ ri√™ng tr√™n domain ch√≠nh
                const detailUrl = `https://cphaco-atct.vercel.app/atct-obit.html?job=${encodeURIComponent(ev.job_id)}`;

                const name = ev.name || ev.deceased_name || "Ch∆∞a r√µ t√™n";
                const birthYear = ev.deceased_birth_year || ev.birth_year || null;

                card.innerHTML = `
          <div class="event-time">${timeText || ""}</div>
          <div>
            <div class="event-badge event-badge--${typeInfo.key}">
              <span class="event-badge-dot"></span>
              <span>${typeInfo.label}</span>
            </div>
            <div class="event-name">
              <span>${name} ${birthYear ? `(${birthYear})` : ""}</span>
            </div>
            ${ev.age_phrase ? `<div class="event-birth">H∆∞·ªüng d∆∞∆°ng ${ev.age_phrase} tu·ªïi</div>` : ""}

            <div class="event-meta">
              ${ev.time_of_death ? "M·∫•t l√∫c: " + formatDateTime(ev.time_of_death) : ""}
            </div>
            <div class="event-actions">
              <a href="${detailUrl}" target="_blank"
                 class="action-pill action-pill--primary obit-link">
                <span class="action-pill-icon">üïØÔ∏è</span>
                <span>M·ªü c√°o ph√≥ ri√™ng</span>
              </a>
              <button type="button"
                      class="action-pill action-pill--ghost qr-link"
                      data-url="${detailUrl}">
                <span class="action-pill-icon">‚ñ¢</span>
                <span>Xem m√£ QR</span>
              </button>
            </div>
          </div>
                    <div class="event-location">
                        ${posText ? "V·ªã tr√≠: " + posText + "<br>" : ""}
                        ${ev.departure_place ? "Xu·∫•t ph√°t t·ª´: " + ev.departure_place : ""}
                    </div>
        `;

                card.addEventListener("click", (e) => {
                    if (e.target.closest(".obit-link") || e.target.closest(".qr-link")) return;
                    openObitModal(ev);
                });

                const qrBtn = card.querySelector(".qr-link");
                qrBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    openQrModal(qrBtn.dataset.url);
                });

                eventsListEl.appendChild(card);
            }
        }
        function buildPositionText(position) {
            const p = position || {};
            const parts = [];
            // Use only tieukhu for compact format
            if (p.tieukhu) {
                parts.push(`Khu ${p.tieukhu}`);
            }
            if (p.row) parts.push(`H√†ng ${p.row}`);
            if (p.index) parts.push(`L√¥ ${p.index}`);
            return parts.join(" ¬∑ ");
        }

        function buildPositionFromEvent(ev) {
            if (ev && ev.position) {
                return buildPositionText(ev.position);
            }
            const p = {
                khu: ev && ev.position_khu,
                tieukhu: ev && ev.position_tieukhu,
                tieukhu_no: ev && ev.position_tieukhu_no,
                row: ev && ev.position_row,
                index: ev && ev.position_index,
            };
            return buildPositionText(p);
        }

        function normalizeText(s) {
            return (s || "")
                .toString()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .trim();
        }

        function applySearchFilter() {
            const q = normalizeText(searchInputEl ? searchInputEl.value : "");
            if (!q) {
                renderEventList(allItems);
                return;
            }
            const filtered = allItems.filter(ev => {
                const name = normalizeText(ev.name || ev.deceased_name);
                const pos = (() => {
                    const parts = [];
                    const p = ev.position || {};
                    const khu = p.khu ?? ev.position_khu;
                    const tieukhu = p.tieukhu ?? ev.position_tieukhu;
                    const tieukhu_no = p.tieukhu_no ?? ev.position_tieukhu_no;
                    const row = p.row ?? ev.position_row;
                    const index = p.index ?? ev.position_index;
                    if (khu) parts.push(khu);
                    if (tieukhu) parts.push(tieukhu);
                    if (tieukhu_no) parts.push(tieukhu_no);
                    if (row) parts.push(row);
                    if (index) parts.push(index);
                    return normalizeText(parts.join(" "));
                })();
                const dep = normalizeText(ev.departure_place);
                return name.includes(q) || pos.includes(q) || dep.includes(q);
            });
            renderEventList(filtered);
        }

        function openObitModal(ev) {
            const typeInfo = getCeremonyInfo(ev);

            const name = ev.name || ev.deceased_name || "";
            obitNameEl.textContent = name;

            // D√≤ng "H∆∞·ªüng d∆∞∆°ng / H∆∞·ªüng th·ªç" l·∫•y t·ª´ API
            if (ev.age_phrase) {
                obitNameAltEl.textContent = ev.age_phrase;
            } else {
                const age = calcAge(
                    ev.birth_year || ev.deceased_birth_year,
                    ev.time_of_death || ev.time_of_funeral
                );
                obitNameAltEl.textContent = age ? `H∆∞·ªüng th·ªç ${age} tu·ªïi` : "";
            }

            // D√≤ng tr√™n c√πng: AN T√ÅNG / C·∫¢I T√ÅNG
            obitRoleEl.textContent = typeInfo.label.toUpperCase();

            const lines = [];

            const year = ev.birth_year || ev.deceased_birth_year;
            if (year) {
                lines.push(`Sinh nƒÉm: ${year}`);
            }
            if (ev.time_of_death) {
                lines.push(
                    `T·ª´ tr·∫ßn l√∫c ${formatDateTime(ev.time_of_death)}${ev.lunar_date ? " (nh·∫±m ng√†y " + ev.lunar_date + ")" : ""
                    }.`
                );
            }
            if (ev.time_of_funeral) {
                lines.push(`<span class="obit-section-title">NGHI TH·ª®C ƒê·ªòNG QUAN</span>`);
                lines.push(`L·ªÖ ƒë·ªông quan l√∫c ${formatDateTime(ev.time_of_funeral)}.`);
            }
            if (ev.departure_place) {
                lines.push(`Xu·∫•t ph√°t t·ª´: ${ev.departure_place}.`);
            }

            const posText = buildPositionFromEvent(ev);

            lines.push(`<span class="obit-section-title">N∆†I AN T√ÅNG</span>`);
            if (posText) {
                lines.push(
                    `Linh c·ªØu ${typeInfo.label.toLowerCase()} t·∫°i: ${posText}, Hoa Vi√™n Nghƒ©a Trang B√¨nh D∆∞∆°ng.`
                );
            } else {
                lines.push(
                    `Linh c·ªØu ${typeInfo.label.toLowerCase()} t·∫°i Hoa Vi√™n Nghƒ©a Trang B√¨nh D∆∞∆°ng.`
                );
            }

            obitBodyEl.innerHTML = lines
                .map((ln) => (ln.startsWith("<span") ? ln : `<div>${ln}</div>`))
                .join("");

            obitFooterEl.textContent =
                `LINH C·ªÆU ${typeInfo.label.toUpperCase()} T·∫†I HOA VI√äN NGHƒ®A TRANG B√åNH D∆Ø∆†NG`;

            obitBackdrop.classList.add("visible");
        }

        function closeObitModal() {
            obitBackdrop.classList.remove("visible");
        }

        obitCloseBtn.addEventListener("click", closeObitModal);
        obitBackdrop.addEventListener("click", (e) => {
            if (e.target === obitBackdrop) closeObitModal();
        });

        async function loadEvents() {
            try {
                const url = API_BASE_URL + "/api/atct/events";
                console.log("Calling:", url);

                const res = await fetch(url, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });

                console.log("Status:", res.status);

                const text = await res.text();
                console.log("Raw response:", text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error("Response kh√¥ng ph·∫£i JSON h·ª£p l·ªá");
                }

                if (!data.ok) throw new Error(data.error || "API tr·∫£ ok=false");
                allItems = data.items || [];
                renderEventList(allItems);
            } catch (err) {
                console.error("loadEvents error:", err);
                eventsListEl.innerHTML =
                    '<div style="padding:10px;font-size:13px;color:#fecaca;">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu an t√°ng/c·∫£i t√°ng. Vui l√≤ng ki·ªÉm tra API.</div>';
            }
        }

        loadEvents();

        if (searchInputEl) {
            searchInputEl.addEventListener("input", applySearchFilter);
        }
    </script>
</body>

</html>